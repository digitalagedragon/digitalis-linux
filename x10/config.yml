rpm_profiles:
  fc33-standalone-gcc:
    installs_from: [ image, local_repo = fc33 ]
    image: fedora-with-rpm
    options: 
      - "--define=_build x86_64-redhat-linux-gnu"
      - "--define=_host x86_64-redhat-linux-gnu"
      - "--define=_target x86_64-pc-linux-gnu"
      - "--define=_fedora_dependencies 1"
      - "--define=dist .fc33"
      - --without
      - threads
      - --with
      - standalone
    additional_podman_args: [ "--volume", "/tmp/dnfcache:/var/cache/dnf" ]
  fc33:
    installs_from: [ image, local_repo = fc33 ]
    image: fedora-with-rpm
    options:
      - "--define=_build x86_64-redhat-linux-gnu"
      - "--define=_host x86_64-redhat-linux-gnu"
      - "--define=_target x86_64-pc-linux-gnu"
      - "--define=_fedora_dependencies 1"
      - "--define=dist .fc33"
    additional_podman_args: [ "--volume", "/tmp/dnfcache:/var/cache/dnf" ]
  digi1:
    installs_from: [ image, local_repo = fc33 ]
    image: fedora-with-rpm
    options: ["--define=_build x86_64-redhat-linux-gnu", "--define=_host x86_64-pc-linux-gnu", "--define=_target x86_64-pc-linux-gnu", "--define=dist .digi1"]
    additional_podman_args: [ "--volume", "/tmp/dnfcache:/var/cache/dnf" ]
  digi2:
    installs_from: [ local_repo = digi1 ]
    image: digitalis-stage1
    options: ["--define=_build x86_64-pc-linux-gnu", "--define=_host x86_64-pc-linux-gnu", "--define=_target x86_64-pc-linux-gnu", "--define=dist .digi2"]
rpm_option_sets:
  fc33-standalone-gcc:
    image: fedora-with-rpm
    options: 
      - "--define=_build x86_64-redhat-linux-gnu"
      - "--define=_host x86_64-redhat-linux-gnu"
      - "--define=_target x86_64-pc-linux-gnu"
      - "--define=_fedora_dependencies 1"
      - "--define=dist .fc33"
      - --without
      - threads
      - --with
      - standalone
  fc33:
    image: fedora-with-rpm
    options:
      - "--define=_build x86_64-redhat-linux-gnu"
      - "--define=_host x86_64-redhat-linux-gnu"
      - "--define=_target x86_64-pc-linux-gnu"
      - "--define=_fedora_dependencies 1"
      - "--define=dist .fc33"
  digi1: 
    image: fedora-with-rpm
    options: ["--define=_build x86_64-redhat-linux-gnu", "--define=_host x86_64-pc-linux-gnu", "--define=_target x86_64-pc-linux-gnu", "--define=dist .digi1"]
build_images:
  fedora-with-rpm:
    script: |
        ctr=$(buildah from fedora:33)

        mkdir -p /tmp/dnfcache
        buildah run --net host "$ctr" sh -c 'echo "keepcache=True" >>/etc/dnf/dnf.conf'
        buildah run --net host --volume /tmp/dnfcache:/var/cache/dnf "$ctr" dnf install -y rpm-build createrepo_c
        buildah run --net host "$ctr" sh -c 'echo "%_topdir /rpmbuild" >>~/.rpmmacros'
        buildah run --net host "$ctr" sh -c 'echo "%_unique_build_ids 1" >>~/.rpmmacros'
        # work around toolchain magic in Fedora 33 setting $CC to random crud
        buildah run --net host "$ctr" sh -c 'sed -i "/  CC=/d" /lib/rpm/redhat/macros'
        buildah run --net host "$ctr" sh -c 'sed -i "/  CXX=/c\\  true" /lib/rpm/redhat/macros'
        buildah run --net host "$ctr" sh -c 'cat >/etc/yum.repos.d/local-bootstrap.repo' <<EOF
        [local-bootstrap]
        name=local-bootstrap
        baseurl=/repo
        enabled=1
        metadata_expire=1s
        gpgcheck=0
        EOF
        buildah commit "$ctr" fedora-with-rpm
    dirs: [ "/tmp/dnfcache" ]
  digitalis-stage1:
    # TODO this suffers from bad
    script: |
        mkdir -p /tmp/repo_digi1
        find ../rpmbuild/RPMS -name '*.'digi1'.*' -exec cp {} /tmp/repo_digi1 ';'
        ctr=$(buildah from fedora-with-rpm)
        VOLUMES="--volume /tmp/dnfcache:/var/cache/dnf --volume /tmp/repo_digi1:/repo"
        podman run --net host $VOLUMES --rm fedora-with-rpm createrepo_c /repo
        buildah run --net host $VOLUMES "$ctr" -- mkdir /new_root
        buildah run --net host $VOLUMES "$ctr" -- dnf install -y \
            --verbose --repo=local-bootstrap --installroot=/new_root --releasever=digi1 \
            fs-tree
        buildah run --net host $VOLUMES "$ctr" -- dnf install -y \
            --verbose --repo=local-bootstrap --installroot=/new_root --releasever=digi1 \
            digitalis-bootstrap-repository base-system

        buildah unshare sh -c 'cp -rp $(buildah mount '$ctr')/new_root /tmp/$(ctr)-new_root'
        buildah umount "$ctr"
        buildah rm "$ctr"

        ctr=$(buildah from scratch)

        buildah copy "$ctr" /tmp/$(ctr)-new_root /
        buildah run --net host --volume /tmp/repo_digi1:/repo "$ctr" -- dnf install -y --releasever=digi1 \
            fs-tree digitalis-bootstrap-repository base-system createrepo_c
        buildah run --net host "$ctr" sh -c 'echo "%_topdir /rpmbuild" >>~/.rpmmacros'
        buildah commit "$ctr" digitalis-stage1
        buildah rm "$ctr"
    installs_from: digi1
    install_packages:
      - fs-tree
      - digitalis-bootstrap-repository
      - base-system
      - createrepo_c
  digitalis-stage2:
    install_strategy: from_target(digi1)
    install_packages:
      - fs-tree
      - digitalis-bootstrap-repository
      - base-system
      - createrepo_c
default_build_target: digitalis
