version: "5.7.5"
bdepend:
  - libs/libelf
  - libs/openssl
  - util/kmod
  - util/cpio
rdepend:
  - util/kmod
  - util/mkinitcpio
  - util/util-linux
filename: linux
upstream: https://cdn.kernel.org/pub/linux/kernel/v5.x/
license: GPL-2.0-only WITH Linux-syscall-note
license_location: spdx
additional_sources: [linux-config]
# additional_source_urls: []
configure: |
  make mrproper
  cp ../linux-config .config
  make olddefconfig
install: |
  make INSTALL_MOD_PATH=/target_root modules_install
  mkdir -p /target_root/boot
  cp -iv arch/$(uname -m)/boot/bzImage /target_root/boot/vmlinuz-%{version}
  cp -iv .config /target_root/boot/config-%{version}
  install -d /target_root/usr/share/doc/linux-%{version}
  cp -r Documentation/* /target_root/usr/share/doc/linux-%{version}
post_install_script: |
  install -v -m755 -d etc/modprobe.d
  cat > etc/modprobe.d/usb.conf << "EOF"
  # Begin /etc/modprobe.d/usb.conf

  install ohci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i ohci_hcd ; true
  install uhci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i uhci_hcd ; true

  # End /etc/modprobe.d/usb.conf
  EOF
# dracut _really does not like_ running outside /. but if you're running this
# script outside of /, you probably don't need an initramfs just yet
#post_unpack_script: |
#  if [[ "$(pwd)" = '/' ]]; then
#    dracut boot/initramfs-%{version}.img --kver %{version}
#  fi
post_unpack_script: |
  if [[ "$(pwd)" = '/' ]]; then
    mkinitcpio -g boot/initramfs-%{version}.img -k %{version}
    mkinitcpio -S autodetect -g boot/initramfs-%{version}-fallback.img -k %{version}
    mkdir /etc/modules-load.d
    mkinitcpio -M | tail -n +2 >/etc/modules-load.d/autodetect.conf
  fi
