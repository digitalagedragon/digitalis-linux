version: "0.23.20.1"
upstream_version: "0.23.20"
bdepend:
  - libs/libtasn1
  - util/make-ca
rdepend:
  - util/make-ca
  - libs/libtasn1
filename: p11-kit
upstream: https://github.com/p11-glue/p11-kit/releases/download/%{upstream_version}
license: BSD-3-Clause
pre_configure_script: |
  sed '20,$ d' -i trust/trust-extract-compat.in &&
  cat >> trust/trust-extract-compat.in << "EOF"
  # Copy existing anchor modifications to /etc/ssl/local
  /usr/libexec/make-ca/copy-trust-modifications

  # Generate a new trust store
  /usr/sbin/make-ca -f -g
  EOF
additional_configure_options: --sysconfdir=/etc --with-trust-paths=/etc/pki/anchors 
# the post_install_script depends on it being installed to /
install: |
  make install
  make DESTDIR=/target_root install
post_install_script: |
  mkdir -pv usr/{lib,bin} etc/
  ln -sfv /usr/libexec/p11-kit/trust-extract-compat usr/bin/update-ca-certificates
  ln -sfv ./pkcs11/p11-kit-trust.so usr/lib/libnssckbi.so
  /usr/sbin/make-ca -g
  cp -r /etc/ssl etc/
  cp -r /etc/pki etc/
